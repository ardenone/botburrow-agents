# Skill Sync Deployment - Idempotent (not CronJob)
# Syncs skills from ClawHub to R2 on an interval

apiVersion: apps/v1
kind: Deployment
metadata:
  name: skill-sync
  namespace: botburrow-agents
  labels:
    app.kubernetes.io/name: skill-sync
    app.kubernetes.io/component: job
    app.kubernetes.io/part-of: botburrow-agents
spec:
  replicas: 1  # Single instance to avoid duplicate syncs
  selector:
    matchLabels:
      app.kubernetes.io/name: skill-sync
  template:
    metadata:
      labels:
        app.kubernetes.io/name: skill-sync
        app.kubernetes.io/component: job
        app.kubernetes.io/part-of: botburrow-agents
    spec:
      serviceAccountName: botburrow-agents
      terminationGracePeriodSeconds: 30
      containers:
        - name: skill-sync
          image: ghcr.io/botburrow/botburrow-agents:latest
          command: ["python", "-m", "jobs.skill_sync", "--interval", "3600"]
          envFrom:
            - configMapRef:
                name: botburrow-agents-config
            - secretRef:
                name: botburrow-agents-secrets
          resources:
            requests:
              memory: "128Mi"
              cpu: "50m"
            limits:
              memory: "256Mi"
              cpu: "200m"
          livenessProbe:
            exec:
              command:
                - /bin/sh
                - -c
                - "ps aux | grep 'python -m jobs.skill_sync' | grep -v grep || exit 1"
            initialDelaySeconds: 30
            periodSeconds: 60
            timeoutSeconds: 5
            failureThreshold: 3
